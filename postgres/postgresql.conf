# =============================================================================
# PostgreSQL 16 — Tuned for 4 GB RAM
# Workload: analytical reads (aggregations, PERCENTILE_CONT, time-series GROUP BY)
# =============================================================================

# ---------------------------------------------------------------------------
# Memory
# ---------------------------------------------------------------------------

# 25% of total RAM — main shared buffer cache
shared_buffers = 1GB

# Tells the planner how much memory the OS will cache (RAM - shared_buffers)
effective_cache_size = 3GB

# Per-operation memory for sorts, hashes, and PERCENTILE_CONT aggregations.
# With max 25 connections and ~2-3 sorts per query, worst case ≈ 25×3×64MB = 4.8GB
# which is acceptable as peak rarely happens simultaneously.
work_mem = 64MB

# Hash operations can use up to work_mem × hash_mem_multiplier
hash_mem_multiplier = 2.0

# Memory for maintenance ops (VACUUM, CREATE INDEX, ALTER TABLE ADD FK)
maintenance_work_mem = 512MB

# ---------------------------------------------------------------------------
# WAL / Checkpoints
# ---------------------------------------------------------------------------

wal_buffers = 16MB

# Spread checkpoint I/O across 90% of the checkpoint interval
checkpoint_completion_target = 0.9

# Allow longer intervals between checkpoints (less I/O pressure)
min_wal_size = 256MB
max_wal_size = 1GB

# ---------------------------------------------------------------------------
# Query Planner
# ---------------------------------------------------------------------------

# SSD storage (Docker volumes are typically on SSD)
random_page_cost = 1.1
effective_io_concurrency = 200

# Default statistics target — higher = better plans for skewed data
default_statistics_target = 200

# ---------------------------------------------------------------------------
# Parallelism (critical for heavy aggregation queries)
# ---------------------------------------------------------------------------

max_worker_processes = 4
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 2

# Lower the threshold so parallel plans kick in for the k6_metrics scans
parallel_tuple_cost = 0.01
parallel_setup_cost = 500

# ---------------------------------------------------------------------------
# JIT Compilation (helps with complex aggregation expressions)
# ---------------------------------------------------------------------------

jit = on

# ---------------------------------------------------------------------------
# Logging (useful for identifying slow queries)
# ---------------------------------------------------------------------------

# Log queries slower than 1 second
log_min_duration_statement = 1000

# ---------------------------------------------------------------------------
# Connection settings
# ---------------------------------------------------------------------------

# Accept connections from all interfaces (required for Docker networking)
listen_addresses = '*'

# Match the app pool config (25 open + headroom for Grafana/admin)
max_connections = 50
